# Оценка риска ДТП

Поступил заказ от каршеринговой компании: нужно создать систему, которая могла бы оценить риск ДТП по выбранному маршруту движения. Под риском понимается вероятность ДТП с любым повреждением транспортного средства. Как только водитель забронировал автомобиль, сел за руль и выбрал маршрут, система должна оценить уровень риска. Если уровень риска высок, водитель увидит предупреждение и рекомендации по маршруту.

Идея создания такой системы находится в стадии предварительного обсуждения и проработки. Чёткого алгоритма работы и подобных решений на рынке ещё не существует. Текущая задача — понять, возможно ли предсказывать ДТП, опираясь на исторические данные одного из регионов.

Идея решения задачи от заказчика: 
1. Создать модель предсказания ДТП (целевое значение — `at_fault` (виновник) в таблице `parties`):
  - Для модели выбрать тип виновника — только машина (car).
  - Выбрать случаи, когда ДТП привело к любым повреждениям транспортного средства, кроме типа `SCRATCH` (царапина).
  - Для моделирования ограничиться данными за 2012 год — они самые свежие.
  - Обязательное условие — учесть фактор возраста автомобиля.
2. На основе модели исследовать основные факторы ДТП.
3. Понять, помогут ли результаты моделирования и анализ важности факторов ответить на вопросы:
  - Возможно ли создать адекватную системы оценки водительского риска при выдаче авто?
  - Какие ещё факторы нужно учесть?
  - Нужно ли оборудовать автомобиль какими-либо датчиками или камерой?

Для создания системы, которая могла бы оценить риск ДТП по выбранному маршруту движения, были переданы данные общей информации о ДТП, информации об участниках ДТП и о пострадавших машинах в виде 3 таблиц.

Таблицы имеют следующий набор данных:
- информация о происшествиях: 1_400_000 строк и 20 колонок;
- описание участников происшествия: 2_752_408 строк и 9 колонок;
- описание автомобиля: 1_021_234 строк и 6 колонок.

При этом представленое описание данных сильно отличается от действительности.

Во всех таблицах присутствовали пропуски:
- информация о происшествиях: в столбцах `direction`, `intersection`, `weather_1`, `location_type`, `primary_collision_factor`, `pcf_violation_category`, `type_of_collision`, `motor_vehicle_involved_with`, `road_surface`, `road_condition_1`, `lighting`, `control_device`, `collision_time`;
- описание участников происшествия: в столбцах `party_type`, `insurance_premium`, `party_sobriety`, `party_drug_physical`, `cellphone_in_use`;
- описание автомобиля: в столбцах `vehicle_transmission`, `vehicle_age`.

Данные не содержали дубликатов.

Так же у таблиц имеется общий ключ для связи - колонка `case_id`.

Все таблицы описывают место и участников ДТП, однако изначальная постановка задачи требует чтобы модель могла определять вероятность ДТП, а для этого необходимы данные и об успешных проездах без ДТП, поэтому приведенных данных для такой постановки задачи недостаточно.

Предложенная идея решения задачи от заказчика сводится к тому чтобы уметь предсказывать являтся ли авто виновником ДТП - это совсем другая ситуация. Для этого варианта постановки задачи данных хватит.

Был подготовлен набор данных на основе первичного предположения заказчика:
- выбран тип виновника — только машина (`car`);
- взяты случаи, когда ДТП привело к любым значимым повреждениям автомобиля любого из участников — все, кроме типа `SCRATCH` (царапина);
- для моделирования взяты данные только за 2012 год;
- подготовка исходной таблицы проводилась с помощью sql-запроса.

Во время работы с пропусками чать пропущенных знаечний, которые составляли меньше 1 процента от данных, были удалены, а так же столбцы `party_drug_physical` и `location_type` - так как они не информативны и пропуски в колонке со значениями суммы страховки, так как это значение сильно связано с навыками водителя, замена пропусков на случайное число, медиану или среднее могло сильно исказить статистику. Остальные заменили на значение `unknown`.

Во время статистического исследования отобранных факторов были выявлены следующие закономерности:
- больше всего аварий произошло с 1 по 5 месяц года включительно, пик ДТП приходится на март
- больше всего аварий происходит днем, чуть меньше - утром и вечером, меньше всего аварий произошло ночью, возможно это связано с тем, что днем поток авто больше, а ночью - наоборот меньше
- большинство аварий произошло не на перекрестке
- в большинстве авто телефон не использовался
- пик аварий приходится на время сухой погоды, чуть меньше аварий происходит при облачной погоде и дожде
- чаще всего основным фактором аварии является нарушение правил дорожного движения
- чаще всего аварии происходят на сухой или мокрой дороге
- чаще всего аварии происходят при движении по направлению на север или на юг
- чаще всего при аварии происходит столкновение с задней частью, реже всего происходит опрокидывание авто
- большую часть аварий составляют авто, в которых нет устройства управления
- в авариях чаще всего присутствуют авто с типом кузова седан и купе
- чаще всего аварии случаются при дневном свете
- чаще всего в аварии есть 2 участника
- чаще всего в аварии виновата скорость
- чаще всего доп участником дтп является другой автомобиль
- чаще всего аварии случаются на нормальном дорожном состоянии
- в большинстве аварии учавствовали трезвые водители
- чаще всего в аварии попадают машины возрастом от 2 до 5 лет
- сумма страховки в основном составляет от 25 до 50 тыс $
- невиновных в авариях в данных на почти 10% больше, чем виновных

Для подготовки модели, кол-ные данные были стандартизированы, качественные - закодированы.

Так как модель должна предсказывать виновника аварии, то задача относится к классификации.

В работе рассмотрено 3 вида моделей:

- логистическая регрессия (линейная модель)
- случайный лес ("деревянная модель")
- catboost (модель градиентного бустинга)

В качестве метрики использована `f1-score`, она применяется в задаче классификации (наша задача такая), описывает сразу два показателя качества модели - полноту и точность. Полнота выявляет, какую долю положительных среди всех ответов выделила модель, а точность - определяет, как много отрицательных ответов нашла модель, пока искала положительные. Таким образом, показатель F1-меры дает более полную оценку качества модели.

Во время обучения моделей случайного леса и градиентного бустинга проводиласть перекрестная проверка.

По итогу на обучении лучший результат показала модель `CatBoostClassifier`, `f1-score = 0.643`. На тесте ее значение составило 0.645.

Лучшие параметры модели:
- `bagging_temperature = 0.7836752884048944`, 
- `border_count = 41`, 
- `depth = 6`, 
- `iterations = 868`, 
- `l2_leaf_reg = 8`, 
- `learning_rate = 0.1674606673046396`, 
- `random_strength = 0.7067540056257035`

Анализ матрицы ошибок показал, что модель неплохо предсказывает истинно положительные и истинно отрицательные значения, большинство ошибок заключается в излишнем прогнозе ложноотрицательных ответов. Метрика точности имеет достаточно хорошее значение, а вот над полнотой можно еще поработать.

Самыми важными факторами для модели стали значения `insurance_premium` (сумма страховки), `primary_collision_factor_vehicle_code_violation` (основной фактор аварии - нарушение кода транспортного средства) и `party_sobriety_had_not_been_drinking` (трезвость участника - не пил).

Исследование зависимости суммы страховки от целевой переменной показало, что сумма страховки виновных в аварии в среднем меньше, чем сумма страховки невиновных. При небольшой сумме страховки - около 20 `тыс $` - наблюдается пик виновных в аварии, при этом сумма страховки невиновных более равномерно распределена в районе от 20 до 50 `тыс-$`.

Из всего выходит что, чтобы учесть фактор во время посадки водителя, нужно ему сообщить что авто застраховано на хорошую сумму. Возможно это позволит водителям быть более расслабленными в процессе езды, что уберет такие негативные факторы как напряжение, суетливость и страх, что позволит водителю почувствовать себя более уверенно.